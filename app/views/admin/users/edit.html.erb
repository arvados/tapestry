<h2><%= @user.full_name -%> -- <%= @user.email -%></h2>

<h3>User details</h3>
<% @user.password = @user.password_confirmation = nil %>

<%= form_for [:admin, @user], :html => { :method => :put } do |f| -%>
<%= error_messages_for :user %>

<p>Completed Content Areas:<br/>
<%= @user.completed_content_area_count %> / <%= ContentArea.count %> (<%= link_to 'Details', admin_user_exam_responses_path(@user) %>)</p>

<p>
  Current Enrollment Step:<br/>
  <% if @user.next_enrollment_step -%>
    <%= @user.next_enrollment_step.ordinal %> <%= @user.next_enrollment_step.title %>
  <% else -%>
    Finished
  <% end -%>
</p>

<% if @user.next_enrollment_step -%>
  <p>Promote to the next enrollment step:<br/>
  <%= link_to 'Promote', promote_admin_user_url(@user), :method => 'PUT' %></p>
<% end -%>

<% if @ccr and @ccr_history.length > 0 %>
<h3>All PHRs</h3>
<table>
<% @ccr_history.each { |version| %>
<tr>
  <td><%= link_to version, ccr_admin_user_url(@user) + '?version=' + version %>
  </td>
</tr>
<% } %>
</table>
<% end %>

<% if @user.waitlists.any? -%>
  <h3>Waitlistings</h3>
  <p>This user has been waitlisted:</p>
  <ol>
    <% @user.waitlists.each do |waitlist| -%>
      <li>On <%= waitlist.created_at %>: <%= h waitlist.reason %></li>
    <% end -%>
  </ol>
<% end -%>

<% if @user.eligibility_survey_version -%>
  <p>This user has passed eligibility survey version <%= @user.eligibility_survey_version %>.
<% end -%>

<h3>Edit User Account</h3>

<p><%= f.label 'PGP #' %><br/>
<%= f.text_field :pgp_id %></p>

<p><%= f.label :first_name %><br/>
<%= f.text_field :first_name %></p>

<p><%= f.label :middle_name %><br/>
<%= f.text_field :middle_name %></p>

<p><%= f.label :last_name %><br/>
<%= f.text_field :last_name %></p>

<p><label for="email">Email</label><br/>
<%= f.text_field :email %></p>

<p><label for="activated">Activated</label><br/>
<%= @user.active? ? @user.activated_at : "No -- activation URL is #{activate_url(@user.activation_code)}" %></p>

<p><label for="password">Password</label><br/>
<%= f.password_field :password %></p>

<p><label for="password_confirmation">Confirm Password</label><br/>
<%= f.password_field :password_confirmation %></p>

<p><label for="security_question">Security Question</label><br/>
<%= f.text_field :security_question, :size => 80 %></p>

<p><label for="security_answer">Security Answer</label><br/>
<%= f.text_field :security_answer, :size => 80 %></p>

<p><label for="is_admin">Is Admin?</label><br/>
<%= f.check_box :is_admin %></p>

<p><label for="is_test">Is test user?</label><br/>
<%= f.check_box :is_test%></p>

<p><label for="deceased">Is deceased?</label><br/>
<%= f.check_box :deceased %></p>

<div style="background: #dddddd; padding: 1em 1em; margin: 0 -1em">

<p><label for="suspended_at">Is suspended?</label>  <i>(no public profile: e.g., requested deletion of data)</i><br/>
<%= f.check_box :suspended_at %> <%= 'since '+@user.suspended_at.ctime if @user.suspended_at %></p>

<p><label for="deactivated_at">Is deactivated?</label>  <i>(e.g., safety questionnaire requirement not satisfied.  Cannot "access or update" account; home page replaced by "your account was deactivated" message)</i><br/>
<%= f.check_box :deactivated_at %> <%= 'since '+@user.deactivated_at.ctime if @user.deactivated_at %></p>

<p><label for="can_reactivate_self">Can auto-reactivate by completing a safety questionnaire?</label><br/>
<%= f.check_box :can_reactivate_self %></p>

<p><b>In order to effectively withdraw this participant</b>, tick both &ldquo;suspended&rdquo; <b>and</b> &ldquo;deactivated&rdquo; boxes.</p>

</div>

<p><label for="researcher">Is researcher?</label><br/>
<%= f.check_box :researcher%></p>

<p><label for="researcher_affiliation">Researcher Affiliation</label><br/>
<%= f.text_field :researcher_affiliation, :size => 80 %></p>

<p><label for="researcher_onirb">Researcher on IRB roster?</label><br/>
<%= f.check_box :researcher_onirb%></p>

<p><label for="mailing_list_subscriptions">Mailing list subscriptions</label><br/>
<table class="admin_table">
  <tr>
    <th>Name</th>
    <th>Subscribed</th>
  </tr>
  <% @mailing_lists.each do |mailing_list| -%>
    <tr class="<%= cycle 'even', 'odd' %>">
      <td><%=h mailing_list.name %></td>
      <td>
        <%= check_box_tag "user[mailing_list_ids][]", mailing_list.id, @user.mailing_list_ids.include?(mailing_list.id) -%> <%= mailing_list.name -%>
      </td>
    </tr>
  <% end %>
</table></p>


<p><%= submit_tag 'Save Changes' %></p>
<% end -%>
